# Cash Flow Sweep Implementation

## Overview

The cash flow sweep mechanism uses excess cash above a minimum balance to pay down debt in priority order (senior debt first). This is a common LBO feature that maximizes debt paydown and improves returns.

## Implementation Details

### Key Features

1. **Available Cash for Sweep (Industry Standard)**
   - **Cash Generated by Operations** = CFO - CapEx
   - **Required Debt Service** = Scheduled Principal + Interest Payments
   - **Available from Operations** = Cash Generated - Required Debt Service - Minimum Cash
   - **Excess Beginning Cash** = Beginning Cash - Minimum Cash (if positive, carryover from previous year)
   - **Total Available for Sweep** = Available from Operations + Excess Beginning Cash
   - **Industry Standard**: Debt can only be paid with cash that the firm generates, not just ending cash balance

2. **Priority-Based Debt Paydown**
   - Debt instruments sorted by priority (1 = senior, 2 = subordinated, etc.)
   - Excess cash pays down debt in priority order
   - Each debt instrument is paid down until either:
     - All excess cash is used, or
     - The debt is fully paid down

3. **Iterative Approach**
   - Up to 5 iterations to handle cascading effects
   - Each iteration:
     1. Applies sweep to use excess cash for debt paydown
     2. Recalculates interest expense for future years
     3. Recalculates affected income statement and cash flow items
     4. Repeats until no more excess cash can be swept

4. **Debt Schedule Integrity**
   - Preserves original debt schedule structure
   - Tracks scheduled vs swept payments separately
   - Maintains continuity: Year N ending = Year N+1 beginning
   - Recalculates future years when debt is paid down early

### Algorithm (Industry Standard)

```
1. Store original debt schedule (before any sweep)
2. For each iteration (up to 5):
   a. For each year:
      - Calculate cash generated = CFO - CapEx
      - Calculate required debt service = Scheduled Principal + Interest
      - Calculate available from operations = Cash Generated - Required Debt Service - Min Cash
      - Calculate excess beginning cash = Beginning Cash - Min Cash (if positive)
      - Total available for sweep = Available from Operations + Excess Beginning Cash
      - For each debt (sorted by priority):
        - Calculate available debt to sweep = Current Ending Balance (must be positive)
        - Sweep amount = min(Total Available for Sweep, Available Debt)
        - Update principal_paid, ending_balance, beginning_balance
        - Update cash flow and balance sheet
        - Ensure ending cash doesn't go below minimum
   b. Recalculate interest expense for all future years
   c. Recalculate income statement and cash flow items
   d. If no sweep applied, break
```

### Industry Standards Compliance

1. **Cash Source**: Debt can only be paid with cash generated by operations (CFO - CapEx), not just ending cash balance
2. **Required Payments**: Scheduled principal and interest must be paid before voluntary sweep
3. **Minimum Cash**: Maintain minimum cash balance throughout
4. **Carryover**: Excess cash from previous year can be used for current year sweep
5. **Debt Continuity**: Year N ending balance = Year N+1 beginning balance (industry standard)
6. **Non-Negative Debt**: Debt balances cannot go negative

### Validation

The sweep implementation includes comprehensive validation:

- **Balance Equation**: Beginning - Principal = Ending
- **Principal Payment**: Principal doesn't exceed beginning balance
- **Ending Balance**: Non-negative
- **Interest Calculation**: Interest = Beginning Balance × Rate
- **Balance Continuity**: Year N ending = Year N+1 beginning
- **Payment Schedule Compliance**: Validates amortizing, bullet, and sweep scenarios
- **Total Debt Reconciliation**: Sum of instruments = Balance Sheet Total Debt

## Example: AuraStream Solutions

### Configuration
- **Initial Debt**: $750M (Senior: $562.5M, Subordinated: $187.5M)
- **Minimum Cash**: $10M
- **Year 1 Ending Cash**: $350.2M (before sweep)

### Sweep Application
- **Excess Cash**: $340.2M ($350.2M - $10M)
- **Senior Debt Sweep**: $492.2M (full remaining balance after scheduled $70.3M payment)
- **Subordinated Debt Sweep**: $187.5M (full balance, bullet debt paid early)
- **Total Sweep**: $679.7M

### Results
- **Year 1 Ending Debt**: $0M (all debt paid down)
- **Year 1 Principal Paid**: 
  - Senior: $562.5M ($70.3M scheduled + $492.2M sweep)
  - Subordinated: $187.5M ($0 scheduled + $187.5M sweep)
- **Validation**: 0 errors, 4 warnings (expected when debt paid down early)

## Benefits

1. **Maximizes Debt Paydown**: Uses all excess cash to pay down debt
2. **Improves Returns**: Lower debt = higher equity value = better IRR/MOIC
3. **Industry Standard**: Matches how real LBO models handle excess cash
4. **Maintains Integrity**: Preserves debt schedule structure and continuity
5. **Handles Cascading Effects**: Recalculates interest and cash flows iteratively

## Technical Notes

### Debt Schedule Recalculation

After sweep is applied, the debt schedule is recalculated for all future years:

- If beginning balance ≤ $0.01: Zero out principal, interest, and ending balance
- If beginning balance > $0.01: Recalculate based on current balance
- Update next year's beginning balance to maintain continuity

### Interest Expense Recalculation

Interest expense is recalculated for all future years after each sweep iteration:

- Interest = Beginning Balance × Interest Rate
- Updated in both debt schedule and income statement
- Affects: Pretax Income, Tax Expense, Net Income, Cash Flow from Operations

### Cash Flow Updates

The sweep updates multiple cash flow items:

- **Debt Repayment**: Increased by sweep amount (more negative = more repayment)
- **Cash Flow from Financing**: Reduced by sweep amount
- **Net Change in Cash**: Reduced by sweep amount
- **Ending Cash Balance**: Reduced by sweep amount
- **Beginning Cash Balance (next year)**: Updated to reflect new ending cash

## Validation Results

The sweep implementation passes all validation checks:

- ✓ Balance equation: Beginning - Principal = Ending
- ✓ Principal payment: Doesn't exceed beginning balance
- ✓ Ending balance: Non-negative
- ✓ Interest calculation: Correct based on beginning balance
- ✓ Balance continuity: Year N ending = Year N+1 beginning
- ✓ Payment schedule: Complies with amortizing/bullet schedules
- ✓ Total debt: Matches balance sheet

## Usage

The sweep is automatically applied when `min_cash_balance > 0`:

```python
assumptions = LBOAssumptions(
    # ... other assumptions ...
    min_cash_balance=10000,  # Enable cash flow sweep
    # ...
)
model = LBOModel(assumptions)
```

The sweep runs automatically during model build, after the cash flow statement is created but before reconciliation.

## Future Enhancements

Potential improvements:
1. Configurable sweep priority (currently uses debt priority)
2. Partial sweep options (e.g., sweep 50% of excess cash)
3. Sweep to specific debt instruments only
4. Dividend payments instead of debt paydown
5. Minimum debt service coverage requirements

